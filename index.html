<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3ì¸ ì˜¤ë¸ë¡œ : ë§¤ì¹­ & AI ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .cell { transition: all 0.2s; }
        .cell:hover:not(.claimed) { transform: scale(1.05); cursor: pointer; }
        .red { background-color: #ef4444; }
        .yellow { background-color: #facc15; }
        .blue { background-color: #3b82f6; }
        .red-light { background-color: #fca5a5; }
        .yellow-light { background-color: #fde68a; }
        .blue-light { background-color: #93c5fd; }
        .cell-player-color { aspect-ratio: 1/1; min-width: 40px; }
        
        /* ëŒ€ê¸°ì—´ ë¦¬ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .queue-item { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 text-gray-800">

    <div id="game-container" class="w-full max-w-5xl bg-white shadow-xl rounded-2xl p-6 md:p-8 flex flex-col md:flex-row gap-8">
        
        <div class="flex-1 flex flex-col">
            <h1 class="text-3xl font-extrabold text-center text-gray-900 mb-2">3ì¸ ì˜¤ë¸ë¡œ (5x5)</h1>
            <p class="text-center text-gray-500 text-sm mb-6">ìƒ‰ì„ ë§ì´ ì°¨ì§€í•˜ì—¬ ìŠ¹ë¦¬í•˜ì„¸ìš”!</p>
            
            <div class="flex justify-between items-center bg-gray-100 rounded-xl p-4 mb-6 shadow-inner">
                <div>
                    <p class="text-xs text-gray-500">ë‚˜ì˜ ìƒíƒœ</p>
                    <p class="font-bold text-lg text-blue-600" id="my-status">ëŒ€ê¸° ì¤‘</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-500">ë‚¨ì€ ì‹œê°„</p>
                    <p class="font-mono font-bold text-2xl text-red-500" id="timer-display">--</p>
                </div>
            </div>

            <div class="flex justify-center mb-6">
                <div id="game-board" class="grid grid-cols-5 gap-1.5 bg-gray-300 p-3 rounded-xl shadow-lg w-full max-w-[400px]">
                    <div class="col-span-5 text-center text-gray-500 py-10">ë§¤ì¹­ì„ ì‹œì‘í•´ì£¼ì„¸ìš”.</div>
                </div>
            </div>

            <div class="mt-auto space-y-3">
                <button id="join-queue-btn" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:-translate-y-1 disabled:opacity-50 disabled:translate-y-0">
                    ğŸ” ë§¤ì¹­ ì‹œì‘ (ëŒ€ê¸°ì—´ ì°¸ê°€)
                </button>
                <button id="force-ai-btn" 
                        class="w-full bg-white border-2 border-gray-300 hover:bg-gray-50 text-gray-700 font-bold py-3 rounded-xl transition hidden">
                    ğŸ¤– ê¸°ë‹¤ë¦¬ê¸° í˜ë“¤ì–´ìš” (AIì™€ ë°”ë¡œ ì‹œì‘)
                </button>
            </div>
        </div>

        <div class="w-full md:w-80 flex flex-col gap-6 border-l border-gray-200 md:pl-8">
            
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                <p class="text-xs text-gray-400 font-bold uppercase mb-1">My Profile</p>
                <p class="text-sm text-gray-600 break-all">ID: <span id="my-user-id" class="font-mono">Connecting...</span></p>
                <p class="text-sm font-bold mt-1">Color: <span id="my-color-display" class="text-gray-400">ì§€ì • ì•ˆë¨</span></p>
            </div>

            <div class="flex-1 bg-blue-50 p-4 rounded-xl border border-blue-100 flex flex-col h-64 md:h-auto overflow-hidden">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-blue-800">ğŸƒ ëŒ€ê¸°ì—´ í˜„í™©</h3>
                    <span id="queue-count" class="bg-blue-200 text-blue-800 text-xs px-2 py-1 rounded-full font-bold">0ëª…</span>
                </div>
                <div id="queue-list" class="flex-1 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                    <p class="text-gray-400 text-sm text-center py-4">ëŒ€ê¸° ì¤‘ì¸ í”Œë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
                <p class="text-xs text-blue-400 text-center mt-2">3ëª…ì´ ëª¨ì´ë©´ ìë™ ì‹œì‘!</p>
            </div>

            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-2">ğŸ† ì ìˆ˜íŒ</h3>
                <ul id="score-list" class="space-y-2 text-sm">
                    <li class="text-gray-400">ê²Œì„ ì‹œì‘ ì „</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="message-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl text-center max-w-sm w-full mx-4 transform transition-all scale-100">
            <h3 id="modal-title" class="text-xl font-bold mb-2 text-gray-900">ì•Œë¦¼</h3>
            <p id="modal-content" class="text-gray-600 mb-6"></p>
            <button onclick="closeModal()" class="w-full bg-gray-900 text-white font-bold py-3 rounded-xl hover:bg-gray-800">í™•ì¸</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, 
            query, where, getDocs, runTransaction, serverTimestamp, orderBy, limit 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ì„¤ì • ---
        const BOARD_SIZE = 5;
        const COLORS = ['R', 'Y', 'B']; 
        const COLOR_MAP = {
            'R': { code: 'red', light: 'red-light', label: 'ë¹¨ê°•' },
            'Y': { code: 'yellow', light: 'yellow-light', label: 'ë…¸ë‘' },
            'B': { code: 'blue', light: 'blue-light', label: 'íŒŒë‘' },
        };
        const MAX_PLAYERS = 3;
        
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyA1DEzZvw6_63cLUk_YeWYRInZ0drIzd5Q",
            authDomain: "color-a6d38.firebaseapp.com",
            projectId: "color-a6d38",
            storageBucket: "color-a6d38.firebasestorage.app",
            messagingSenderId: "761735384766",
            appId: "1:761735384766:web:cc52566ccafac650a558ef"
        };
        const appId = 'Color-Game-V2'; // V2 Namespace for queue system

        // Globals
        let app, db, auth, userId;
        let queueDocId = null; // My queue ticket ID
        let gameId = null;
        let myColor = null;
        let unsubscribeQueue = null;
        let unsubscribeGame = null;
        let unsubscribeMyTicket = null; // Listen to my own queue ticket for match info

        // UI Elements
        const joinBtn = document.getElementById('join-queue-btn');
        const aiBtn = document.getElementById('force-ai-btn');
        const queueListEl = document.getElementById('queue-list');
        const queueCountEl = document.getElementById('queue-count');
        const boardElement = document.getElementById('game-board');
        const myStatusEl = document.getElementById('my-status');
        const timerDisplay = document.getElementById('timer-display');
        const scoreList = document.getElementById('score-list');

        // Game State
        let currentBoardState = [];
        let selectedCell = null;
        let isResolving = false;
        let timerInterval = null;

        // --- ì´ˆê¸°í™” ---
        async function init() {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            await signInAnonymously(auth);
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('my-user-id').textContent = userId.substring(0, 8) + '...';
                    joinBtn.disabled = false;
                    
                    // ëŒ€ê¸°ì—´ ì „ì²´ í˜„í™©ì€ í•­ìƒ ë³´ì—¬ì¤Œ (ì°¸ê°€ ì•ˆí–ˆì–´ë„)
                    watchQueueList(); 
                }
            });
        }
        window.onload = init;

        // --- ëŒ€ê¸°ì—´(Queue) ë¡œì§ ---

        // 1. ëŒ€ê¸°ì—´ ì°¸ê°€
        joinBtn.addEventListener('click', async () => {
            if (!userId) return;
            joinBtn.disabled = true;
            joinBtn.textContent = "ë§¤ì¹­ ì¤‘...";
            aiBtn.classList.remove('hidden'); // AI ë²„íŠ¼ ë³´ì´ê¸°
            myStatusEl.textContent = "ëŒ€ê¸°ì—´ ì§„ì…";

            try {
                // Queue ì»¬ë ‰ì…˜ì— ë‚´ í‹°ì¼“ ìƒì„±
                const queueRef = collection(db, 'artifacts', appId, 'public', 'data', 'queue');
                const ticketRef = doc(queueRef, userId); // Use userId as doc ID for simplicity
                
                await setDoc(ticketRef, {
                    userId: userId,
                    joinedAt: serverTimestamp(),
                    matchId: null // ë§¤ì¹­ë˜ë©´ ê²Œì„ IDê°€ ì—¬ê¸° ì í˜
                });
                
                queueDocId = userId;
                
                // ë‚´ í‹°ì¼“ ê°ì‹œ (ë§¤ì¹­ ì„±ê³µ ì—¬ë¶€ í™•ì¸)
                watchMyTicket(ticketRef);

            } catch (e) {
                console.error(e);
                alert("ëŒ€ê¸°ì—´ ì°¸ê°€ ì‹¤íŒ¨");
                resetUI();
            }
        });

        // 2. ë‚´ í‹°ì¼“ ê°ì‹œ ë° ë§¤ì¹­ í™•ì¸
        function watchMyTicket(docRef) {
            unsubscribeMyTicket = onSnapshot(docRef, (docSnap) => {
                if (!docSnap.exists()) {
                    // ëˆ„êµ°ê°€(í˜¹ì€ ë‚˜)ì— ì˜í•´ íì—ì„œ ì œê±°ë¨ -> ê²Œì„ ì‹œì‘ í˜¹ì€ ì·¨ì†Œ
                    // (ì—¬ê¸°ì„œëŠ” matchIdê°€ ì—…ë°ì´íŠ¸ë˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ì‚­ì œëŠ” ê²Œì„ ì°¸ê°€ í›„ ì²˜ë¦¬)
                    return;
                }
                const data = docSnap.data();
                if (data.matchId) {
                    // ë§¤ì¹­ ì„±ê³µ!
                    console.log("ë§¤ì¹­ ì„±ê³µ! ê²Œì„ ID:", data.matchId);
                    enterGame(data.matchId);
                }
            });
        }

        // 3. ì „ì²´ ëŒ€ê¸°ì—´ ê°ì‹œ & ìë™ ë§¤ì¹­ íŠ¸ë¦¬ê±° (í•µì‹¬ ë¡œì§)
        function watchQueueList() {
            const queueRef = collection(db, 'artifacts', appId, 'public', 'data', 'queue');
            const q = query(queueRef, orderBy('joinedAt', 'asc'));

            unsubscribeQueue = onSnapshot(q, (snapshot) => {
                const docs = snapshot.docs;
                renderQueueList(docs);

                // *** ë§¤ì¹­ ë¡œì§ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ) ***
                // ë‚´ê°€ ëŒ€ê¸°ì—´ì— ìˆê³ , ëŒ€ê¸°ì—´ ì¸ì›ì´ 3ëª… ì´ìƒì¼ ë•Œ
                // "ë™ì‹œì„± ì œì–´"ë¥¼ ìœ„í•´, ì •ë ¬ëœ ëª©ë¡ì˜ **3ë²ˆì§¸ ì‚¬ëŒ**ì´ ì´ëŒ€ë¥¼ ë©”ê³  ê²Œì„ì„ ìƒì„±í•¨.
                if (queueDocId && docs.length >= 3) {
                    const top3 = docs.slice(0, 3);
                    const myIndex = top3.findIndex(d => d.id === userId);
                    
                    // ë‚´ê°€ 3ëª… ì¤‘ 3ë²ˆì§¸ ì‚¬ëŒ(ì¸ë±ìŠ¤ 2)ì´ë¼ë©´ ê²Œì„ ìƒì„± íŠ¸ë¦¬ê±°
                    if (myIndex === 2) {
                        createMatchedGame(top3);
                    }
                }
            });
        }

        // 4. ë§¤ì¹­ëœ ê²Œì„ ìƒì„± (3ë²ˆì§¸ ì‚¬ëŒì´ ì‹¤í–‰)
        async function createMatchedGame(usersDocs) {
            console.log("3ëª…ì´ ëª¨ì—¬ ë§¤ì¹­ì„ ì‹œì‘í•©ë‹ˆë‹¤. í˜¸ìŠ¤íŠ¸:", userId);
            
            // ìƒˆ ê²Œì„ ID ìƒì„±
            const gamesRef = collection(db, 'artifacts', appId, 'public', 'data', 'games');
            const newGameRef = doc(gamesRef);
            const newGameId = newGameRef.id;

            const playersData = {};
            const playerOrder = [];
            
            usersDocs.forEach((d, idx) => {
                const uid = d.data().userId;
                playersData[uid] = {
                    color: COLORS[idx], // ìˆœì„œëŒ€ë¡œ ìƒ‰ê¹” ë°°ì •
                    isAI: false,
                    score: 0,
                    lastMove: null
                };
                playerOrder.push(uid);
            });

            // ì´ˆê¸° ë³´ë“œ
            const initialBoard = Array(BOARD_SIZE).fill(0).map(() => Array(BOARD_SIZE).fill(''));

            // Transaction: ê²Œì„ ìƒì„± + íì˜ ìœ ì €ë“¤ì—ê²Œ matchId ë¶€ì—¬
            try {
                await runTransaction(db, async (transaction) => {
                    // 1. ê²Œì„ ë¬¸ì„œ ìƒì„±
                    transaction.set(newGameRef, {
                        status: 'playing', // ë°”ë¡œ ì‹œì‘
                        turn: 1,
                        timer: 5,
                        board: JSON.stringify(initialBoard),
                        players: playersData,
                        playerOrder: playerOrder,
                        hostId: userId, // 3ë²ˆì§¸ ì‚¬ëŒì´ ì„ì‹œ í˜¸ìŠ¤íŠ¸
                        createdAt: serverTimestamp()
                    });

                    // 2. ëŒ€ê¸°ì—´ ìœ ì €ë“¤ì—ê²Œ ì‹ í˜¸ ë³´ë‚´ê¸° (matchId ì—…ë°ì´íŠ¸)
                    for (const d of usersDocs) {
                        const qRef = doc(db, 'artifacts', appId, 'public', 'data', 'queue', d.id);
                        transaction.update(qRef, { matchId: newGameId });
                    }
                });
            } catch (e) {
                console.error("ë§¤ì¹­ ìƒì„± íŠ¸ëœì­ì…˜ ì‹¤íŒ¨:", e);
            }
        }

        // 5. AIì™€ ë°”ë¡œ ì‹œì‘ (ê°•ì œ ì‹œì‘)
        aiBtn.addEventListener('click', async () => {
            if (!queueDocId) return;
            
            if(!confirm("í˜„ì¬ ëŒ€ê¸°ì—´ì—ì„œ ë‚˜ê°€ê³  AIì™€ ê²Œì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            // íì—ì„œ ë‚˜ê°
            await leaveQueue();
            
            // ì†”ë¡œ ê²Œì„ ìƒì„±
            await createSoloGame();
        });

        async function leaveQueue() {
             if (queueDocId) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'queue', queueDocId));
                if(unsubscribeMyTicket) unsubscribeMyTicket();
                queueDocId = null;
            }
        }

        async function createSoloGame() {
            const gamesRef = collection(db, 'artifacts', appId, 'public', 'data', 'games');
            const newGameRef = doc(gamesRef);
            const initialBoard = Array(BOARD_SIZE).fill(0).map(() => Array(BOARD_SIZE).fill(''));
            
            // ë‚˜ + AI 2ëª…
            const playersData = {
                [userId]: { color: 'R', isAI: false, score: 0, lastMove: null },
                'AI_Y': { color: 'Y', isAI: true, score: 0, lastMove: null },
                'AI_B': { color: 'B', isAI: true, score: 0, lastMove: null }
            };

            await setDoc(newGameRef, {
                status: 'playing',
                turn: 1,
                timer: 5,
                board: JSON.stringify(initialBoard),
                players: playersData,
                playerOrder: [userId, 'AI_Y', 'AI_B'],
                hostId: userId,
                createdAt: serverTimestamp()
            });

            enterGame(newGameRef.id);
        }

        // --- ê²Œì„ ì§„ì… ë° ë¡œì§ ---

        async function enterGame(id) {
            gameId = id;
            
            // í ì •ë¦¬ (ë§¤ì¹­ë˜ì–´ì„œ ë“¤ì–´ê°€ëŠ” ê²½ìš°, ë‚´ í‹°ì¼“ ì‚­ì œ)
            // ì£¼ì˜: ë‹¤ë¥¸ ì‚¬ëŒ í‹°ì¼“ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ (ê°ìê°€ ìê¸°êº¼ ì‚­ì œí•˜ê±°ë‚˜ ë‚˜ì¤‘ì— ì •ë¦¬)
            // ì—¬ê¸°ì„œëŠ” ê¹”ë”í•˜ê²Œ ë‚´ê²ƒë§Œ ì§€ìš°ê³  ì§„ì…
            await leaveQueue();

            // UI ì „í™˜
            joinBtn.classList.add('hidden');
            aiBtn.classList.add('hidden');
            queueListEl.parentElement.classList.add('hidden'); // ëŒ€ê¸°ì—´ ìˆ¨ê¹€ (ì„ íƒì‚¬í•­)
            document.getElementById('game-container').classList.remove('max-w-5xl');
            document.getElementById('game-container').classList.add('max-w-4xl'); // ì‚¬ì´ì¦ˆ ì¡°ì •

            myStatusEl.textContent = "ê²Œì„ ì ‘ì† ì¤‘...";

            // ê²Œì„ ë¦¬ìŠ¤ë„ˆ
            unsubscribeGame = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), (docSnap) => {
                if(!docSnap.exists()) {
                    alert("ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    location.reload();
                    return;
                }
                handleGameUpdate(docSnap.data());
            });
        }

        // --- ê¸°ì¡´ ê²Œì„ ë¡œì§ (ë³´ë“œ ì²˜ë¦¬, íƒ€ì´ë¨¸, AI ë“±) ---
        // (ì´ì „ ì½”ë“œì˜ í•µì‹¬ ë¡œì§ì„ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜¤ë˜ UI ì—°ê²° ë¶€ë¶„ ìµœì í™”)

        function handleGameUpdate(gameData) {
            // 1. ë‚´ ì •ë³´ í™•ì¸
            const myData = gameData.players[userId];
            if (myData) {
                myColor = myData.color;
                const cInfo = COLOR_MAP[myColor];
                myStatusEl.innerHTML = `<span class="text-${cInfo.code}-600 font-bold">${cInfo.label}</span> í”Œë ˆì´ì–´`;
                document.getElementById('my-color-display').textContent = cInfo.label;
                document.getElementById('my-color-display').className = `font-bold text-${cInfo.code}-600`;
            } else {
                myStatusEl.textContent = "ê´€ì „ ì¤‘";
            }

            // 2. ë³´ë“œ ë Œë”ë§
            currentBoardState = JSON.parse(gameData.board);
            renderBoard(currentBoardState, gameData);

            // 3. ì ìˆ˜íŒ
            renderScoreboard(gameData.players);

            // 4. ìƒíƒœ ì²˜ë¦¬
            if (gameData.status === 'playing') {
                timerDisplay.textContent = gameData.timer;
                
                // í˜¸ìŠ¤íŠ¸(ë°©ì¥)ê°€ íƒ€ì´ë¨¸ ë° í„´ ì²˜ë¦¬ ë‹´ë‹¹
                if (userId === gameData.hostId) {
                    manageHostLogic(gameData);
                }
            } else if (gameData.status === 'finished') {
                timerDisplay.textContent = "END";
                showWinner(gameData.players);
            }
        }

        // í˜¸ìŠ¤íŠ¸ ë¡œì§ (íƒ€ì´ë¨¸ + í„´ ì¢…ë£Œ + AI)
        function manageHostLogic(gameData) {
            // íƒ€ì´ë¨¸ ì‘ë™ (ë¡œì»¬ì—ì„œ ì¸í„°ë²Œ ëŒë¦¬ë©° DB ì—…ë°ì´íŠ¸)
            // *ìµœì í™”: ë§¤ì´ˆ DB ì“°ê¸°ëŠ” ë¹„ìš©ì´ í¼. ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„  TimeStamp ë¹„êµ ë°©ì‹ ì‚¬ìš© ê¶Œì¥.
            // ì—¬ê¸°ì„  ê¸°ì¡´ ë¡œì§ ìœ ì§€í•˜ë˜ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            
            if (!timerInterval && gameData.timer > 0) {
                let timeLeft = gameData.timer;
                timerInterval = setInterval(async () => {
                    timeLeft--;
                    // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (í˜¸ìŠ¤íŠ¸ë§Œ)
                    // timerDisplay.textContent = timeLeft; 
                    
                    if (timeLeft >= 0) {
                         // DB ì—…ë°ì´íŠ¸ (ë‹¤ë¥¸ ì‚¬ëŒë“¤ì—ê²Œ ì‹œê°„ ì „íŒŒ)
                         await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), { timer: timeLeft });
                    }

                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        if (!isResolving) resolveTurn(gameData);
                    }
                }, 1000);
            }
        }

        async function resolveTurn(gameData) {
            isResolving = true;
            timerDisplay.textContent = "íŒì •";

            let board = JSON.parse(gameData.board);
            // Deep copy board
            board = board.map(row => [...row]);

            const players = gameData.players;
            let moves = [];

            // 1. í”Œë ˆì´ì–´ & AI ì›€ì§ì„ ìˆ˜ì§‘
            // AI ì›€ì§ì„ ìƒì„± (í˜¸ìŠ¤íŠ¸ê°€ ëŒ€ì‹  ìˆ˜í–‰)
            for (const pid in players) {
                const p = players[pid];
                if (p.isAI) {
                    const aiMove = getRandomMove(board);
                    if (aiMove) moves.push({ id: pid, color: p.color, r: aiMove.r, c: aiMove.c });
                } else if (p.lastMove) {
                    moves.push({ id: pid, color: p.color, r: p.lastMove.r, c: p.lastMove.c });
                }
            }

            // 2. ì¶©ëŒ ì²˜ë¦¬ (ê°™ì€ ì¹¸ 2ëª… ì´ìƒì´ë©´ ë¬´íš¨)
            const posCounts = {};
            moves.forEach(m => { const key = `${m.r},${m.c}`; posCounts[key] = (posCounts[key] || 0) + 1; });
            const validMoves = moves.filter(m => posCounts[`${m.r},${m.c}`] === 1 && board[m.r][m.c] === '');

            // 3. ë³´ë“œ ì ìš© & ì˜¤ë¸ë¡œ ë£°
            validMoves.forEach(m => {
                board[m.r][m.c] = m.color;
                applyOthello(board, m.r, m.c, m.color);
            });

            // 4. ì ìˆ˜ ê³„ì‚°
            let newScores = {};
            let filled = 0;
            for(let r=0; r<BOARD_SIZE; r++) {
                for(let c=0; c<BOARD_SIZE; c++) {
                    const cell = board[r][c];
                    if(cell) {
                        newScores[cell] = (newScores[cell] || 0) + 1;
                        filled++;
                    }
                }
            }

            // 5. í”Œë ˆì´ì–´ ìƒíƒœ ì—…ë°ì´íŠ¸
            const updatedPlayers = {};
            for (const pid in players) {
                updatedPlayers[pid] = {
                    ...players[pid],
                    lastMove: null, // ì´ˆê¸°í™”
                    score: newScores[players[pid].color] || 0
                };
            }

            const isEnd = filled >= (BOARD_SIZE * BOARD_SIZE);

            // 6. DB ì €ì¥
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                board: JSON.stringify(board),
                players: updatedPlayers,
                turn: gameData.turn + 1,
                timer: 5, // ì‹œê°„ ë¦¬ì…‹
                status: isEnd ? 'finished' : 'playing'
            });

            isResolving = false;
        }

        // ë³´ë“œ í´ë¦­ (í”Œë ˆì´ì–´ ì•¡ì…˜)
        window.handleCellClick = async (r, c) => {
            if (!gameId || !myColor || isResolving) return;
            if (currentBoardState[r][c] !== '') return;

            // ì‹œê°ì  í”¼ë“œë°±
            selectedCell = { r, c };
            renderBoard(currentBoardState, { status: 'playing' }); // ì¬ë Œë”ë§ìœ¼ë¡œ í…Œë‘ë¦¬ í‘œì‹œ

            // ì„œë²„ ì „ì†¡
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                [`players.${userId}.lastMove`]: { r, c }
            });
        };

        // --- ìœ í‹¸ë¦¬í‹° & ë Œë”ë§ ---

        function renderQueueList(docs) {
            queueCountEl.textContent = `${docs.length}ëª…`;
            queueListEl.innerHTML = '';
            
            if (docs.length === 0) {
                queueListEl.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">ëŒ€ê¸° ì¤‘ì¸ í”Œë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            docs.forEach(d => {
                const isMe = d.id === userId;
                const el = document.createElement('div');
                el.className = `queue-item p-2 rounded-lg text-sm flex justify-between items-center ${isMe ? 'bg-blue-200 border border-blue-300 shadow-sm' : 'bg-white border border-gray-100'}`;
                el.innerHTML = `
                    <span class="font-mono ${isMe ? 'font-bold text-blue-700' : 'text-gray-600'}">
                        ${isMe ? 'ë‚˜ (Me)' : d.id.substring(0, 6) + '..'}
                    </span>
                    <span class="text-xs text-gray-400">ëŒ€ê¸°ì¤‘</span>
                `;
                queueListEl.appendChild(el);
            });
        }

        function renderBoard(board, gameData) {
            boardElement.innerHTML = '';
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    const cellVal = board[r][c];
                    const div = document.createElement('div');
                    div.className = `cell cell-player-color rounded-md flex items-center justify-center shadow-sm ${cellVal ? 'claimed' : 'bg-white'}`;
                    
                    if (cellVal) {
                        div.classList.add(COLOR_MAP[cellVal].code);
                    } else if (gameData.status === 'playing' && myColor) {
                        div.onclick = () => window.handleCellClick(r, c);
                        // ë‚´ ì„ íƒ í‘œì‹œ
                        if (selectedCell && selectedCell.r === r && selectedCell.c === c) {
                             div.classList.add('ring-4', 'ring-gray-800', COLOR_MAP[myColor].light);
                        }
                    }
                    boardElement.appendChild(div);
                }
            }
        }

        function renderScoreboard(players) {
            scoreList.innerHTML = '';
            const list = Object.values(players).sort((a,b) => b.score - a.score);
            list.forEach(p => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center p-2 rounded bg-white shadow-sm";
                li.innerHTML = `
                    <span class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-${COLOR_MAP[p.color].code}-500"></div>
                        <span class="${p.color === myColor ? 'font-bold' : ''}">${p.isAI ? 'AI' : 'Player'}</span>
                    </span>
                    <span class="font-bold text-lg">${p.score}</span>
                `;
                scoreList.appendChild(li);
            });
        }
        
        // ì˜¤ë¸ë¡œ ì•Œê³ ë¦¬ì¦˜ (8ë°©í–¥ ë’¤ì§‘ê¸°)
        function applyOthello(board, r, c, color) {
            const dirs = [[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]];
            dirs.forEach(([dr, dc]) => {
                let nr = r + dr, nc = c + dc, flippable = [];
                while(nr>=0 && nr<BOARD_SIZE && nc>=0 && nc<BOARD_SIZE) {
                    if(board[nr][nc] === '') break;
                    if(board[nr][nc] === color) {
                        flippable.forEach(f => board[f.r][f.c] = color);
                        break;
                    }
                    flippable.push({r:nr, c:nc});
                    nr += dr; nc += dc;
                }
            });
        }

        function getRandomMove(board) {
            let empties = [];
            for(let r=0; r<BOARD_SIZE; r++) 
                for(let c=0; c<BOARD_SIZE; c++) 
                    if(board[r][c] === '') empties.push({r,c});
            return empties.length ? empties[Math.floor(Math.random()*empties.length)] : null;
        }

        function showWinner(players) {
             const winner = Object.values(players).sort((a, b) => b.score - a.score)[0];
             const myScore = players[userId]?.score || 0;
             const isWin = players[userId] && winner.color === players[userId].color;
             
             document.getElementById('modal-title').textContent = isWin ? "ìŠ¹ë¦¬! ğŸ‰" : "ê²Œì„ ì¢…ë£Œ";
             document.getElementById('modal-content').textContent = `1ë“±: ${COLOR_MAP[winner.color].label} (${winner.score}ì )\në‚´ ì ìˆ˜: ${myScore}ì `;
             document.getElementById('message-modal').classList.remove('hidden');
        }

        window.closeModal = () => document.getElementById('message-modal').classList.add('hidden');
        
        function resetUI() {
            joinBtn.disabled = false;
            joinBtn.textContent = "ğŸ” ë§¤ì¹­ ì‹œì‘ (ëŒ€ê¸°ì—´ ì°¸ê°€)";
            joinBtn.classList.remove('hidden');
            aiBtn.classList.add('hidden');
        }
    </script>
</body>
</html>